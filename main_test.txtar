# testscript framework tests for grol's main binary / command line

# Basic usage test
!grol -foo
!stdout .
stderr 'flag provided but not defined: -foo'

# (short) version
grol version
stdout '^dev$'
!stderr .

# (long) version
grol buildinfo
stdout '^dev  go'
stdout 'path	grol.io/grol'
!stderr .

# most basic expression
grol -c '1+1'
stdout '^2$'
stderr welcome
!stderr 'rror' # no Errors or other case/singular/plural

# syntax error
!grol -c 'foo'
stderr 'Errors'
stderr 'identifier not found: foo'
stdout '<err: identifier not found: foo>'

# sample_test.gr
grol sample_test.gr
!stderr 'Errors'
cmp stdout sample_test_stdout
stderr 'I] Running sample_test.gr'
stderr 'called fact 5'
stderr 'called fact 1'
stderr 'I] All done'

# fib_50.gr
grol fib_50.gr
!stderr 'Errors'
cmp stdout fib50_stdout
stderr 'I] Running fib_50.gr'
stderr 'I] All done'

# Bug repro, return aborts the whole program
grol -c 'f=func(){return 1;2};log(f());f();3'
stdout '^1\n3$'
!stderr 'Errors'

# same one more level
grol -c 'f=func(n){if (n==5) {return 1};2};log(f(5));f(5);3'
stdout '^1\n3$'
!stderr 'Errors'

# test bad macro as well as indirectly the error() builtin
!grol -c 'm=macro(){};m()'
stdout '^<err: macro should return Quote. got=object.Null \({}\)>\n$'

# quiet mode and fast fibbonaci (log won't show)
grol -quiet -c 'fib=func(x){log("fib",x);if x<=1 {x} else {fib(x-1)+fib(x-2)}}; fib(92)'
stdout '^7540113804746346429\n$'
!stdout '\n\n'
!stderr .

-- sample_test.gr --
// Sample file that our gorepl can interpret
// <--- comments
// See also the other *.gr files

unless = macro(cond, iffalse, iftrue) {
    quote(if (!(unquote(cond))) {
        unquote(iffalse)
    } else {
        unquote(iftrue)
    })
}

unless(10 > 5, print("BUG: not greater\n"), print("macro test: greater\n"))

fact=func(n) { // function
    log("called fact", n) // log (timestamped stderr output)
    if (n<=1) {
        return 1
    }
    n*fact(n-1) // recursion, also last evaluated expression is returned (ie return at the end is optional)
}

a=[fact(5), "abc", 76-3] // array can contain different types

m={"key": a, 73: 29} // so do maps

println("m is:", m) // stdout print
println("Outputting a smiley: ðŸ˜€")

first(m["key"]) // get the value from key from map, which is an array, and the first element of the array is our factorial 5
// could also have been m["key"][0]

// ^^^ gorepl sample.gr should output 120

-- fib_50.gr --
fib = func(x) {
	if (x == 0) {
		return 0
	}
	if (x == 1) {
		return 1
	}
	fib(x - 1) + fib(x - 2)
}
fib(50)
-- sample_test_stdout --
macro test: greater
m is: {73:29,"key":[120,"abc",73]}
Outputting a smiley: ðŸ˜€
120
-- fib50_stdout --
12586269025
