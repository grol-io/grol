<!doctype html>
<html>
<!--
  xterm.js based interactive REPL for grol.
  Uses globalThis.fs overrides to bridge stdin/stdout/stderr between
  the Go WASM runtime and xterm.js. The Go side uses x/term.Terminal
  for line editing (ANSI escape sequences), which xterm.js renders.

  Keep grol/wasm/xterm.html and web-site/_includes/xterm.html in sync.
  make wasm to test changes.
-->

<head>
    <meta charset="utf-8">
    <title>Grol REPL</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5/css/xterm.css">
    <link rel="stylesheet" href="/term.css">
    <style>
        body {
            background: #1e1e1e;
            color: #ccc;
        }

        .xterm {
            height: 100%;
        }
    </style>
</head>

<body>
    <div id="header">
        <span id="version">Loading GROL...</span>
        <a href="/index.html">Textarea</a> mode
        <a href="/ghostty.html">ghostty-web</a> mode
        <span id="status"></span>
    </div>
    <div id="image-container">
        <button id="close-image" onclick="closeImage()">&times;</button>
        <img id="image" src="" alt="Image output">
    </div>
    <div id="terminal-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/@xterm/xterm@5/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0/lib/addon-fit.js"></script>
    <script src="/wasm_exec.js"></script>
    <script src="/term.js"></script>
    <script>
        // ─── xterm.js Terminal Setup ─────────────────────────────────
        const xterm = new Terminal({
            cursorBlink: true,
            fontSize: 15,
            fontFamily: '"Cascadia Code", "Fira Code", "JetBrains Mono", Menlo, Monaco, "Courier New", monospace',
            theme: {
                background: '#1e1e1e',
                foreground: '#d4d4d4',
                cursor: '#d4d4d4',
                selectionBackground: '#264f78',
            },
            convertEol: false,  // We handle \r\n ourselves (x/term.Terminal does CRLF)
            allowProposedApi: true,
        });

        const fitAddon = new FitAddon.FitAddon();
        xterm.loadAddon(fitAddon);
        xterm.open(document.getElementById('terminal-container'));
        fitAddon.fit();

        // Set terminal globals for fortio.org/terminal WASM detection.
        // These must be set before go.run() so IsTerminal() returns true.
        globalThis.TerminalConnected = true;
        globalThis.TerminalCols = xterm.cols;
        globalThis.TerminalRows = xterm.rows;

        window.addEventListener('resize', () => {
            fitAddon.fit();
            // Update globals for fortio.org/terminal's platformGetSize
            globalThis.TerminalCols = xterm.cols;
            globalThis.TerminalRows = xterm.rows;
            // Also notify Go directly if the function is registered
            if (typeof grolSetTermSize === 'function') {
                grolSetTermSize(xterm.cols, xterm.rows);
            }
        });

        // VFS, stdin/stdout bridge, and WASM init are in /term.js
        setupGrolTerminal(xterm, {
            onImageShow: () => fitAddon.fit(),
            onImageClose: () => fitAddon.fit(),
        });
    </script>
</body>

</html>
